<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Samstag, April 14, 2018, 7:36  -->
<!-- MuClient version 5.05 -->

<!-- Plugin "speedwalking" generated by Plugin Wizard -->

<muclient>
<plugin
   name="speedwalking"
   author="Magician"
   id="12e9bfa9a98aa54bd54349a6"
   language="Lua"
   purpose="Ermöglicht das Laufen von Ort zu Ort in Avalon"
   date_written="2018-04-14 07:34:25"
   requires="4.70"
   version="1.0"
   save_state="n"
   >

</plugin>

<aliases>
  <alias
   match="safespeedwalks_switch"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>safespeedwalks_switch()</send>
</alias>
  <alias
   match="speedwalk_break"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>speedwalk_break()</send>
</alias>
  <alias
   match="^/(.*?)$"
   enabled="y"
   send_to="12"
   sequence="100"
   regexp="y"
  >
  <send>speedwalk_start("%1")</send>
</alias>
  <alias
   match="pos"
   enabled="y"
   send_to="12"
   sequence="101"
  >
  <send>print_position()</send>
</alias>
</aliases>

<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Script  -->


<script>
<![CDATA[
require("avalon.speedwalking.speedwalking")
Path = require("pl.path")
PPI = require("ppi")
Avalon = PPI.Load(world.GetPluginVariable("", "avalon"))
Dunkel = 0
RoomID = nil
SafeSpeedwalks = 1
world.DoAfterSpecial(0.5, "PluginInstall()", 12)

function PluginInstall()
  world.Accelerator("ctrl+D", "speedwalk_break")
  world.Accelerator("F5", "safespeedwalks_switch")
  Avalon.HookCallback('DUNKEL', OnAvalonDunkel)
  Avalon.HookCallback('ROOMID', OnAvalonRoomID)
  Avalon.HookCallback('CLOSE', OnAvalonClose)
  SafeSpeedwalks = Avalon.GetConfig('settings', 'SafeSpeedwalks') or 1
end

function OnAvalonDunkel(dunkel)
  Dunkel = dunkel
end

function OnAvalonRoomID(id, name, x, y)
  if id ~= RoomID then
    station_name = stations_getnamebyroomid(id)
    if station_name ~= nil then
      if (Path.exists(GetInfo(74).."Stations/"..station_name..".ogg")) then
        stationsnd = GetInfo(74).."Stations/"..station_name..".ogg"
      else
        stationsnd = GetInfo(74).."Stations/Misc.ogg"
      end
      Avalon.PSND(stationsnd)
    end
  end
  RoomID = id
end

function OnAvalonClose()
  Avalon.SetConfig('settings', 'SafeSpeedwalks', SafeSpeedwalks)
end

function OnPluginScreendraw(type, log, line)
  if type == 0 then
    speedwalk_process(true)
  end
end

function OnPluginTick()
  speedwalk_process()
end

-- falls von hier aus speedwalks starten, werden diese ausgegeben
function print_position()
  if (SafeSpeedwalks == 1) then
    list = stations_getspeedwalksbyroomid(RoomID)
    if (#list == 1) then
      msg = "\nVon hier startet ein Speedwalk:\n"
      for number, walk in pairs(list) do
        msg = msg.."\t"..walk
        if (speedwalksafety[walk]) then
          msg = msg..' (sicher)'
        else
          msg = msg.." (unsicher)"
        end
        msg = msg.."\n"
      end
      msg = string.sub(msg, 1, -2)
      world.Note(msg)
    end
    if (#list > 1) then
      msg = "\nVon hier starten "..#list.." Speedwalks:\n"
      for number, walk in pairs(list) do
        msg = msg.."\t"..walk
        if (speedwalksafety[walk]) then
          msg = msg.." (sicher)"
        else
          msg = msg.." (unsicher)"
        end
        msg = msg.."\n"
      end
      msg = string.sub(msg, 1, -2)
      world.Note(msg)
    end
  end
end

function safespeedwalks_switch()
  SafeSpeedwalks = 1 - SafeSpeedwalks
  if (SafeSpeedwalks == 0) then
    world.Note("Die Speedwalks werden nicht mehr abgesichert.")
  else
    world.Note("Die Speedwalks werden nun abgesichert.")
  end
  Avalon.PSND("Misc/ConfigSwitch.ogg")
end
]]>
</script>


</muclient>
