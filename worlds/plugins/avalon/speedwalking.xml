<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Samstag, April 14, 2018, 7:36  -->
<!-- MuClient version 5.05 -->

<!-- Plugin "speedwalking" generated by Plugin Wizard -->

<muclient>
<plugin
   name="speedwalking"
   author="Magician"
   id="12e9bfa9a98aa54bd54349a6"
   language="Lua"
   purpose="Ermöglicht das Laufen von Ort zu Ort in Avalon"
   date_written="2018-04-14 07:34:25"
   requires="4.70"
   version="1.0"
   save_state="n"
   >

</plugin>

<aliases>
  <alias
   match="safespeedwalks_switch"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>safespeedwalks_switch()</send>
</alias>
  <alias
   match="speedwalk_break"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>speedwalk_break()</send>
</alias>
  <alias
   match="^/([a-zA-Z0-9]*\.?[a-zA-Z0-9]*)_?([a-zA-Z0-9]*\.?[a-zA-Z0-9]*)$"
   enabled="y"
   send_to="12"
   sequence="100"
   regexp="y"
  >
  <send>speedwalk_start("%1", "%2")</send>
</alias>
  <alias
   match="^/_([a-zA-Z0-9]*\.?[a-zA-Z0-9]*)$"
   enabled="y"
   send_to="12"
   sequence="100"
   regexp="y"
  >
  <send>speedwalk_start("", "%1")</send>
</alias>
  <alias
   match="//"
   enabled="y"
   send_to="12"
   sequence="100"
  >
  <send>speedwalk_list()</send>
</alias>
  <alias
   match="pos"
   enabled="y"
   send_to="12"
   sequence="101"
  >
  <send>print_position()</send>
</alias>
</aliases>

<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Script  -->


<script>
<![CDATA[
require("natsort")
require("speedwalking.speedwalking")
List = require("pl.list")
Path = require("pl.path")
Stations = require("avalon.stations")
String = require("pl.stringx")
Tablex = require("pl.tablex")
PPI = require("ppi")
Avalon = PPI.Load(world.GetPluginVariable("", "avalon"))
Dunkel = 0
RoomID = nil
SafeSpeedwalks = 1
Stations:parse_speedwalks(require("avalon.speedwalks"))
world.DoAfterSpecial(0.5, "PluginInstall()", 12)

function PluginInstall()
  world.Accelerator("ctrl+D", "speedwalk_break")
  world.Accelerator("F5", "safespeedwalks_switch")
  Avalon.HookCallback('DUNKEL', OnAvalonDunkel)
  Avalon.HookCallback('ROOMID', OnAvalonRoomID)
  Avalon.HookCallback('CLOSE', OnAvalonClose)
  SafeSpeedwalks = Avalon.GetConfig('settings', 'SafeSpeedwalks') or 1
end

function OnPluginInstall()
  PPI.Expose('AddStation', function(domain, name, id, description)
    domain = domain:lower()
    name = name:lower()
    id = id:lower()
    possible_stations = Stations:find(id)
    local i
    for i = 1, possible_stations:len() do
      if possible_stations[i].name == name and possible_stations[i].domain == domain then
        return
      end
    end
    Stations:add(domain, name, id, description)
  end)
  PPI.Expose('AddSpeedwalk', function(source, target, path)
    possible_sources = Stations:find(source)
    if possible_sources:len() == 0 then
      return false
    end
    possible_targets = Stations:find(target)
    if possible_targets:len() == 0 then
      return false
    end
    speedwalks = {}
    possible_sources:foreach(function(s)
      possible_targets:foreach(function(t)
        speedwalks[s.domain.."."..s.name.."_"..t.domain.."."..t.name] = path
      end)
    end)
    Stations:parse_speedwalks(speedwalks, true)
    return true
  end)
end

function OnAvalonDunkel(dunkel)
  Dunkel = dunkel
end

function OnAvalonRoomID(id, name, x, y)
  if id ~= RoomID then
    stations = Stations:find(id)
    if stations:len() >= 1 then
      if (Path.exists(GetInfo(74).."Stations/"..stations[1].name..".ogg")) then
        stationsnd = GetInfo(74).."Stations/"..stations[1].name..".ogg"
      else
        stationsnd = GetInfo(74).."Stations/Misc.ogg"
      end
      Avalon.PSND(stationsnd)
    end
  end
  RoomID = id
end

function OnAvalonClose()
  Avalon.SetConfig('settings', 'SafeSpeedwalks', SafeSpeedwalks)
end

function OnPluginScreendraw(type, log, line)
  if type == 0 then
    speedwalk_process(true)
  end
end

function OnPluginTick()
  speedwalk_process()
end

-- falls von hier aus speedwalks starten, werden diese ausgegeben
function print_position()
  if (SafeSpeedwalks == 1) then
    if Dunkel == 1 then
      world.Note("Ohne Licht sind keine weiteren Informationen verfuegbar.")
    else
      stations = Stations:find(RoomID)
      if stations:len() == 0 then
        world.Note("Fuer diesen Ort existiert kein Speedwalk.")
      else
        world.Note("Dieser Ort ist als "..stations:map(function(s) return String.title(s.domain).."."..String.title(s.name) end):join(" und ").." an das Speedwalk-System angebunden.")
      end
    end
  end
end

function safespeedwalks_switch()
  SafeSpeedwalks = 1 - SafeSpeedwalks
  if (SafeSpeedwalks == 0) then
    world.Note("Die Speedwalks werden nicht mehr abgesichert.")
  else
    world.Note("Die Speedwalks werden nun abgesichert.")
  end
  Avalon.PSND("Misc/ConfigSwitch.ogg")
end

function speedwalk_start(from, to)
  -- die verschiedenen faelle
  -- es wird weder von, noch nach angegeben -> ein paar informationen
  if from == "" and to == "" then
    local msg = "Das Speedwalking in Avalon\n"
    msg = msg.."In Avalon kann man von Ort zu Ort laufen, indem man den Befehl /, gefolgt von\n"
    msg = msg.."den Start- und Zielpositionen angibt.\n"
    msg = msg.."Die Positionen werden dabei in zwei Teile geteilt: die Domaene und den Ort.\n"
    msg = msg.."Die Domaene gibt den uebergeordneten Bereich an, waehrend der Ort sehr\n"
    msg = msg.."spezifisch ist. Moechte man beispielsweise von Alotria aus in die Bank in\n"
    msg = msg.."Minias laufen, so kann man /nereid.alotria_minias.bank verwenden.\n"
    msg = msg.."Hinweis: Die Domaene und der Ort koennen so weit wie moeglich abgekuerzt werden,\n"
    msg = msg.."solange sie eindeutig bleiben. /ne.alo_min.bank funktioniert also auch.\n"
    msg = msg.."Sollte es einen Ort mit einem bestimmten Namen nur ein einziges Mal geben,\n"
    msg = msg.."koennt ihr die Domaene auch entfallen lassen.\n"
    msg = msg.."Eine Information zu jedem bekannten Ort bekommt ihr mittels /domaene.ort\n"
    msg = msg.."Und eine Liste aller Domaenen und Orte erhaltet ihr mittels //.\n"
    msg = msg.."Wenn ihr euch bereits an einem bekannten Ort befindet, reicht es auch, wenn\n"
    msg = msg.."ihr nur die Zielposition angebt. Es reicht dann /_min.bank"
    world.Note(msg)
    return
  end
  -- es wird nur von angegeben -> wir geben ein paar informationen fuer diese location aus
  if from ~= "" and to == "" then
    stations = Stations:find(from)
    if stations:len() == 0 then
      world.Note("Es gibt keinen Ort mit diesem Namen.")
    elseif stations:len() > 1 then
      world.Note("Dieser Name trifft auf die folgenden Orte zu:\n"..stations:map(function(s) return String.title(s.domain).."."..String.title(s.name) end):join(", "))
    else
      msg = "Name: "..String.title(stations[1].name).."\n"
      msg = msg.."Domaene: "..String.title(stations[1].domain).."\n"
      msg = msg.."Beschreibung: "..stations[1].description
      world.Note(msg)
    end
    return
  end
  -- es wird nur to angegeben, wir laufen also von hier los, falls moeglich
  if from == "" then
    if SafeSpeedwalks == 1 and Dunkel == 1 then
      world.Note("Um Speedwalks abzusichern, muss es auf Deinem Feld hell sein. Umschalten kannst Du die Absicherung mit der F5-Taste.")
      return
    end
    stations = Stations:find(RoomID)
  else
    stations = Stations:find(from)
  end
  if stations:len() == 0 then
    world.Note("Dieser Startpunkt ist derzeit nicht bekannt.")
    return
  end
  if stations:len() > 1 then
    world.Note("Dieser Startpunkt trifft auf mehrere Orte zu:\n"..stations:map(function(s) return String.title(s.domain).."."..String.title(s.name) end):join(", "))
    return
  end
  from = stations[1]
  stations = Stations:find(to)
  if stations:len() == 0 then
    world.Note("Dieser Zielpunkt ist derzeit nicht bekannt.")
    return
  end
  if stations:len() > 1 then
    world.Note("Dieser Zielpunkt trifft auf mehrere Orte zu:\n"..stations:map(function(s) return String.title(s.domain).."."..String.title(s.name) end):join(", "))
    return
  end
  to = stations[1]
  if from == to then
    world.Note("Du bist doch schon hier.")
    return
  end
  speedwalk_init(from, to)
end

function speedwalk_list()
  local msg = ""
  msg = msg..tostring(Stations.stations:len()).." Orte bekannt:\n"
  -- die Liste aller Domaenen mit orten bauen
  domains = {}
  Stations.stations:foreach(function(s)
    if domains[s.domain] == nil then
      domains[s.domain] = List.new()
    end
    domains[s.domain]:append(s.name)
  end)
  for k,v in Tablex.sort(domains) do
    msg = msg..String.title(k)..":\n"
    for _, v2 in ipairs(natsort(v)) do
      msg = msg.."\t"..String.title(v2).."\n"
    end
  end
  msg = msg:sub(1, -2)
  world.Note(msg)
end
]]>
</script>


</muclient>
